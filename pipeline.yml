parameters:
  - name: RelativePathToTerraformFiles
    type: string
  - name: TFStateBlobName
    type: string
  - name: TFStateResourceGroupName
    type: string
  - name: TFStateStorageAccountName
    type: string
  - name: TFStateContainerName
    type: string
  - name: VariablesTemplateRelativePath
    type: string
  - name: TerraformVariableMappings
    type: object

resources:
  repositories:
    - repository: UKHOTemplates
      type: github
      endpoint: UKHO
      name: UKHO/devops-pipelinetemplates
      ref: refs/heads/main
    - repository: GatedInfrastructureDeploy
      type: github
      endpoint: UKHO
      name: UKHO/devops-gated-infrastructure-deploy
      ref: refs/tags/1.0.0
  containers:
    - container: TerraformContainer
      image: ukhydrographicoffice/terraform-powershell:1.8.5

stages:
  - template: build-stage.yml
    parameters:
      RelativePathToTerraformFiles: ${{ parameters.RelativePathToTerraformFiles }}

  - template: checks-stage.yml
    parameters:
      RelativePathToTerraformFiles: ${{ parameters.RelativePathToTerraformFiles }}

  - template: deploy-stage.yml
    parameters:
      Environment: dev
      DependsOn:
        - "Build"
      TFStateBlobName: ${{ parameters.TFStateBlobName }}
      TFStateResourceGroupName: ${{ parameters.TFStateResourceGroupName }}
      TFStateStorageAccountName: ${{ parameters.TFStateStorageAccountName }}
      TFStateContainerName: ${{ parameters.TFStateContainerName }}
      VariablesTemplateRelativePath: ${{ parameters.VariablesTemplateRelativePath }}
      TerraformVariableMappings: ${{ parameters.TerraformVariableMappings }}

  - template: deploy-stage.yml
    parameters:
      Environment: qa
      DependsOn:
        - "Checks"
        - "Deploy_dev"
      Condition: succeeded('Checks', 'Deploy_dev')
      TFStateBlobName: ${{ parameters.TFStateBlobName }}
      TFStateResourceGroupName: ${{ parameters.TFStateResourceGroupName }}
      TFStateStorageAccountName: ${{ parameters.TFStateStorageAccountName }}
      TFStateContainerName: ${{ parameters.TFStateContainerName }}
      VariablesTemplateRelativePath: ${{ parameters.VariablesTemplateRelativePath }}
      TerraformVariableMappings: ${{ parameters.TerraformVariableMappings }}

  - template: deploy-stage.yml
    parameters:
      Environment: live
      DependsOn:
        - "Deploy_qa"
      TFStateBlobName: ${{ parameters.TFStateBlobName }}
      TFStateResourceGroupName: ${{ parameters.TFStateResourceGroupName }}
      TFStateStorageAccountName: ${{ parameters.TFStateStorageAccountName }}
      TFStateContainerName: ${{ parameters.TFStateContainerName }}
      VariablesTemplateRelativePath: ${{ parameters.VariablesTemplateRelativePath }}
      TerraformVariableMappings: ${{ parameters.TerraformVariableMappings }}